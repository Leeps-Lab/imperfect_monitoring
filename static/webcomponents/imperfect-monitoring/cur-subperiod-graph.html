<link
    rel="import"
    href="/static/bower_components/polymer/polymer.html" />

<dom-module id="cur-subperiod-graph">

<template>
    <div id="chart"></div>
</template>

<script>
    Polymer({
        is: 'cur-subperiod-graph',
        properties: {
            payoffMatrix: {
                type: Array,
            },
            subperiodLength: {
                type: Number,
            },
            aColor: {
                type: String,
            },
            bColor: {
                type: String,
            },
            _payoffs: {
                type: Array,
                value: () => [],
            },
            _maxPayoff: {
                type: Number,
                computed: '_computeMaxPayoff(payoffMatrix)',
            },
            _payoffBounds: {
                type: Array,
                computed: '_computePayoffBounds(payoffMatrix)',
            },
        },
        ready() {
            this.async(this._initHighchart.bind(this), 1);
        },
        addPayoff(payoff) {
            if (!this.graph_obj)
                return;
            
            this.push('_payoffs', payoff);

            // add a null to the end of the payoff array so highcharts calculates column widths correctly
            this.graph_obj.series[0].setData(this.get('_payoffs').concat([null]));
        },
        addAverageLine() {
            if (!this.graph_obj)
                return;

            const realized_payoffs = this.get('_payoffs');
            const avg = realized_payoffs.reduce((a, b) => a + b, 0) / realized_payoffs.length; 
            
            // add average line to graph
            // use -999 and 999 so line stretches all the way across graph
            this.graph_obj.series[1].setData([[-999, avg], [999, avg]]);
        },
        addPayoffBounds(decision) {
            if (!this.graph_obj)
                return;

            // get color and min and max payoffs from _payoffBounds map
            const payoff_bounds = this.get(['_payoffBounds', decision]);

            this.graph_obj.series[2].options.color = payoff_bounds.color;
            this.graph_obj.series[2].update(this.graph_obj.series[2].options);
            this.graph_obj.series[3].options.color = payoff_bounds.color;
            this.graph_obj.series[3].update(this.graph_obj.series[3].options);

            // use -999 and 999 so line always stretches all the way across the graph
            this.graph_obj.series[2].setData([[-999, payoff_bounds.min], [999, payoff_bounds.min]]);
            this.graph_obj.series[3].setData([[-999, payoff_bounds.max], [999, payoff_bounds.max]]);
        },
        clearGraph() {
            this.set('_payoffs', []);
            for (let series of this.graph_obj.series) {
                series.setData([]);
            }
        },
        _computeMaxPayoff(payoffMatrix) {
            return Math.max.apply(null, payoffMatrix);
        },
        // _payoffBounds is an array that maps decisions to an object
        // that gives the line color and max/min payoffs for that decision
        _computePayoffBounds(payoffMatrix) {
            return [
                {
                    color: this.bColor,
                    min: Math.min(payoffMatrix[2], payoffMatrix[3]),
                    max: Math.max(payoffMatrix[2], payoffMatrix[3]),
                },
                {
                    color: this.aColor,
                    min: Math.min(payoffMatrix[0], payoffMatrix[1]),
                    max: Math.max(payoffMatrix[0], payoffMatrix[1]),
                }
            ];
        },
        _initHighchart() {
            this.graph_obj = Highcharts.chart({
                chart: {
                    animation: false,
                    renderTo: this.$.chart,
                    enabled: false,
                    width: 150,
                    height: 400,
                },
                title: { 
                    text: null
                },
                exporting: { enabled: false },
                tooltip: { enabled: false },
                legend: { enabled: false },
                credits: { enabled: false },
                xAxis: {
                    min: 0,
                    max: this.subperiodLength - 1,
                    labels: { enabled: false },
                    tickLength: 0,
                },
                yAxis: {
                    title: { text: undefined },
                    min: 0,
                    // set max to a little more than the max payoff
                    // so that payoff bounds at top don't get cut off
                    max: this._maxPayoff * 1.05,
                    endOnTick: false,
                    labels: { enabled: true },
                },
                plotOptions: {
                    column: {
                        groupPadding: 0,
                    },
                    line: {
                        marker: {
                            enabled: false
                        },
                        linecap: "square"
                    },
                    series: {
                        states: {
                            hover: {
                                enabled: false,
                            }
                        }
                    }
                },
                series: [
                    {
                        name: "Realized Payoffs",
                        type: "column",
                        data: [],
                    },
                    {
                        name: "Average Payoff",
                        type: "line",
                        data: [],
                    },
                    {
                        name: "Min Payoff",
                        type: "line",
                        lineWidth: 5,
                        data: [],
                    },
                    {
                        name: "Max Payoff",
                        type: "line",
                        lineWidth: 5,
                        data: [],
                    },
                ],
            });
        },
    });
</script>
</dom-module>